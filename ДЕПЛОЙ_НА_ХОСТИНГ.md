# Порядок размещения и запуска проекта на хостинге

Пошаговая инструкция, чтобы выложить мини-апп «Курьер» и запустить его в продакшене.

---

## 1. Подготовка: что нужно заранее

- **PostgreSQL** — база на хостинге (например: Railway, Render, Supabase, свой VPS).
- **Telegram-бот** — создан в [@BotFather](https://t.me/BotFather), получен токен.
- **Два домена/URL** (или один с путями):
  - для **фронта** (Mini App): например `https://app.ваш-домен.ru`;
  - для **API**: например `https://api.ваш-домен.ru` (или тот же домен с путём `/api`).
- **Node.js 18+** на сервере бэкенда (если деплой на VPS).

---

## 2. База данных

1. Создайте базу PostgreSQL и скопируйте строку подключения.
2. Формат:  
   `postgresql://USER:PASSWORD@HOST:5432/DBNAME?schema=public`

---

## 3. Бэкенд (API)

### 3.1. Переменные окружения

В каталоге **`backend/`** создайте файл **`.env`** (или задайте переменные в панели хостинга):

```env
# Обязательно
DATABASE_URL="postgresql://USER:PASSWORD@HOST:5432/DBNAME?schema=public"
TELEGRAM_BOT_TOKEN="123456:ABC-..."
JWT_SECRET="случайная-строка-не-менее-32-символов"
TELEGRAM_BOT_USERNAME="ваш_бот"   # без @

# По желанию
JWT_EXPIRES_IN="7d"
PORT=3000
NODE_ENV=production

# Яндекс.Карты (для экрана карты)
YANDEX_MAPS_API_KEY="ваш-ключ"
```

- **JWT_SECRET** — придумайте длинную случайную строку (≥ 32 символов).
- **TELEGRAM_BOT_USERNAME** — имя бота, например `drivergo_bot`.

### 3.2. Миграции и запуск (локально один раз или на сервере)

```bash
cd backend
npm install
npx prisma migrate deploy
npm run build
npm run start:prod
```

Или на хостинге (Railway, Render и т.п.) укажите:
- **Build:** `npm install && npx prisma generate && npm run build`
- **Start:** `npx prisma migrate deploy && node dist/main` (или `npm run start:prod`)
- Все переменные из `.env` пропишите в настройках сервиса.

### 3.3. CORS (рекомендуется)

В **`backend/src/main.ts`** для продакшена укажите домен фронта:

```ts
app.enableCors({
  origin: ['https://app.ваш-домен.ru'],
  credentials: true,
});
```

После правки снова соберите: `npm run build`.

---

## 4. Фронтенд (Mini App)

### 4.1. Указать URL API

Перед загрузкой приложения фронт должен знать адрес API.

**Вариант А** — API на отдельном домене. В **`frontend/index.html`** в `<head>` добавьте первой строкой:

```html
<script>window.APP_API_BASE = 'https://api.ваш-домен.ru';</script>
```

**Вариант Б** — тот же домен, запросы на `/api`. Настроить прокси (nginx/Vercel/Netlify), чтобы `/api` проксировался на бэкенд. Тогда ничего не менять или задать:

```html
<script>window.APP_API_BASE = '';</script>
```

(пустая строка = текущий origin, запросы идут на тот же сайт).

### 4.2. Сборка и выкладка

```bash
cd frontend
npm install
npm run build
```

Содержимое папки **`frontend/dist/`** выложите на хостинг:
- **Vercel / Netlify:** привязать репозиторий к папке `frontend`, в настройках Build: `npm run build`, Publish: `dist`;
- или залить `dist/` по FTP/SSH на свой сервер и отдавать через nginx как статику.

Фронт должен открываться по **HTTPS** (Telegram требует HTTPS для Web App).

---

## 5. Настройка Telegram

1. **Mini App URL**  
   В [@BotFather](https://t.me/BotFather) → ваш бот → Menu Button / Mini App укажите URL фронта, например:  
   `https://app.ваш-домен.ru`

2. **Webhook (если реализован)**  
   Если в проекте есть эндпоинт для приёма контакта от бота (например `POST /api/telegram/webhook`), в BotFather или через API задайте webhook:  
   `https://api.ваш-домен.ru/api/telegram/webhook`

---

## 6. Краткий порядок действий (чек-лист)

| № | Действие |
|---|----------|
| 1 | Создать БД PostgreSQL, скопировать `DATABASE_URL` |
| 2 | Создать бота в BotFather, получить `TELEGRAM_BOT_TOKEN` |
| 3 | В `backend/` создать `.env`, заполнить переменные |
| 4 | Выполнить миграции: `cd backend && npx prisma migrate deploy` |
| 5 | Собрать и запустить бэкенд на хостинге (или локально для проверки) |
| 6 | В `frontend/index.html` при необходимости задать `window.APP_API_BASE` |
| 7 | Собрать фронт: `cd frontend && npm run build` |
| 8 | Выложить `frontend/dist/` на хостинг по HTTPS |
| 9 | В BotFather указать URL Mini App (адрес фронта) |
| 10 | Открыть бота в Telegram и проверить запуск приложения |

---

## 7. Проверка

- Открыть бота в Telegram → запустить Mini App.
- Должен открыться фронт, затем авторизация (Telegram → при необходимости телефон через бота → выбор роли).
- После входа доступны: заявки, карта, профиль.

Если API на другом домене — в браузере проверьте, что запросы к API не блокируются CORS и возвращают 200/401, а не ошибки сети.
